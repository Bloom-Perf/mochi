# This file contains the CI workflow for the Mochi project.
# For simplicity we are compiling and testing everything on the Ubuntu environment only.

name: Mochi CI

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_REGISTRY_DIR: ~/.cargo/registry

on:
  workflow_dispatch:  # Allows manual execution
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**.md'
      - 'docs/**'

# Avoid concurrent executions
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check:
    name: ðŸ” Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout sources
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: ðŸ¦€ Install stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ðŸ” Run cargo check
        run: |
          echo "ðŸ” Running cargo check..."
          cargo check
          echo "âœ… Cargo check completed successfully!"

  test:
    name: ðŸ§ª Test Suite
    needs: check
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip-tests]') }}
    steps:
      - name: ðŸ“¥ Checkout sources
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: ðŸ¦€ Install stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ðŸ§ª Run cargo test
        run: |
          echo "ðŸ§ª Starting test suite execution..."
          cargo test
          echo "âœ… All tests passed successfully!"

  clippy:
    name: ðŸ”¬ Clippy
    needs: check
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip-clippy]') }}
    steps:
      - name: ðŸ“¥ Checkout sources
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: ðŸ¦€ Install stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: ðŸ”¬ Run cargo clippy
        run: |
          echo "ðŸ”¬ Running Clippy analysis..."
          cargo clippy
          echo "âœ… Clippy checks passed!"

  fmt:
    name: ðŸ“ Format
    needs: check
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip-fmt]') }}
    steps:
      - name: ðŸ“¥ Checkout sources
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: ðŸ¦€ Install stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: ðŸ“ Run cargo fmt
        run: |
          echo "ðŸ“ Checking code formatting..."
          cargo fmt --all -- --check
          echo "âœ… Code formatting check passed!"

# Summary job that runs even if some jobs are skipped
  pipeline-summary:
    name: ðŸ“‹ Pipeline Summary
    needs: [check, test, clippy, fmt]
    runs-on: ubuntu-latest
    if: always()
  
    steps:
      - name: ðŸ“Š Generate Pipeline Summary
        run: |
          echo "## ðŸ¡ Mochi CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        
          # List skipped steps
          if [[ "${{ contains(github.event.head_commit.message, '[skip-fmt]') }}" == "true" ]]; then
            echo "â­ï¸ Format check was skipped via [skip-fmt]" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ contains(github.event.head_commit.message, '[skip-clippy]') }}" == "true" ]]; then
            echo "â­ï¸ Clippy analysis was skipped via [skip-clippy]" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ contains(github.event.head_commit.message, '[skip-tests]') }}" == "true" ]]; then
            echo "â­ï¸ Tests were skipped via [skip-tests]" >> $GITHUB_STEP_SUMMARY
          fi
        
          # Add job status summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Job Status" >> $GITHUB_STEP_SUMMARY
          echo "* ðŸ” Check: ${{ needs.check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "* ðŸ§ª Tests: ${{ needs.test.result || 'Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "* ðŸ”¬ Clippy: ${{ needs.clippy.result || 'Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "* ðŸ“ Format: ${{ needs.fmt.result || 'Skipped' }}" >> $GITHUB_STEP_SUMMARY